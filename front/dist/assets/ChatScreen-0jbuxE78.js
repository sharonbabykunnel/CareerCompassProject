import{e as J,r as o,j as e,P as te,n as se,o as ae,b as re,c as ce,u as M,q as ne,h as k,t as oe,v as ie,w as F,x as G,y as le}from"./index-DNBWHiOW.js";import{M as de,V as ue,$ as fe,C as he,a as me,F as pe,b as ge}from"./ChatHeader-Dmr8VFRR.js";import{u as xe}from"./useUploadFile-UMd3XqSf.js";import{F as P}from"./popup-DFjubwHb.js";import{H as je}from"./Header_user-CC_W8Z2p.js";import"./lodash-fBqRUI97.js";import"./url-C7Fa9dY1.js";import"./search-D8ZgcwT8.js";import"./x-wBWLGZiv.js";import"./arrow-left-DCYn3C7e.js";import"./useInfiniteQuery-Cz-diVX2.js";import"./SearchBar-ih9sQ4JT.js";import"./image-BiiIF2vD.js";import"./index.esm2017-BS_sI9wt.js";import"./firebase-B1n_VfNi.js";import"./share-2-5rSeMMrW.js";import"./briefcase-business-C8NabOBn.js";/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ye=J("MicOff",[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]]);/**
 * @license lucide-react v0.411.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ve=J("VideoOff",[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]),be=({socket:c,receiver:x,chat:u,user:i,peer:l,setMe:I,caller:_,receivingCall:y})=>{const[N,p]=o.useState(!1),[v,T]=o.useState(!1),[b,S]=o.useState(!1),[w,O]=o.useState({video:!0,audio:!0}),d=o.useRef(),f=o.useRef();o.useRef(),o.useEffect(()=>(navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(s=>{d.current.srcObject=s}),l.on("open",s=>{}),l.on("call",s=>{d.current.srcObject.checkOn="checkOn",s.answer(d.current.srcObject),p(!0),s.on("stream",r=>{f.current.srcObject=r})}),c.on("videoStateChange",s=>{var r;if((r=f==null?void 0:f.current)!=null&&r.srcObject){const h=f.current.srcObject.getVideoTracks()[0];h&&(h.enabled=s)}}),c.on("audioStateChange",s=>{var r;if((r=f==null?void 0:f.current)!=null&&r.srcObject){const h=f.current.srcObject.getAudioTracks()[0];h&&(h.enabled=s)}}),()=>{var s;d.current&&((s=d.current.srcObject)==null||s.getTracks().forEach(r=>r.stop()))}),[b]);const A=()=>{if(!l)return;const s=l==null?void 0:l.id;console.log("peer",s),S(!0),s?c.emit("callUser",x.uid,s,i):l.on("open",r=>{c.emit("callUser",x.uid,r,i)})},D=()=>{p(!0),S(!0),l.call(_,d.current.srcObject).on("stream",r=>{f.current.srcObject=r})},E=()=>{T(!0),l&&l.destroy(),d.current&&d.current.srcObject.getTracks().forEach(s=>s.stop()),I(!1)},C=()=>{const s=d.current.srcObject.getVideoTracks()[0],r=!s.enabled;s.enabled=r,O(h=>({...h,video:r})),c.emit("videoStateChange",u.chat._id,r)},V=()=>{const s=d.current.srcObject.getAudioTracks()[0],r=!s.enabled;s.enabled=r,O(h=>({...h,audio:r})),c.emit("audioStateChange",u.chat._id,r)};return e.jsx("div",{className:"flex flex-col h-[90vh]",children:b&&!v?e.jsxs("div",{className:"relative w-full h-screen bg-gray-100 flex items-center justify-center",children:[e.jsx("div",{className:"w-full max-w-3xl aspect-video bg-gray-800 rounded-lg shadow-lg overflow-hidden",children:e.jsxs("div",{className:"w-full h-full relative",children:[e.jsx("video",{playsInline:!0,ref:f,autoPlay:!0,alt:"Main caller",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute bottom-4 right-4 w-1/4 aspect-video bg-white rounded-lg overflow-hidden shadow-md",children:e.jsx("video",{playsInline:!0,muted:!0,ref:d,autoPlay:!0,alt:"Secondary caller",className:"w-full h-full object-cover"})})]})}),e.jsxs("div",{className:"absolute bottom-8 left-1/2 transform -translate-x-1/2 flex space-x-4",children:[e.jsx("button",{onClick:V,className:"p-4 bg-gray-700 rounded-full text-white hover:bg-gray-600",children:w.audio?e.jsx(de,{size:24}):e.jsx(ye,{size:24})}),e.jsx("button",{onClick:E,className:"p-4 bg-red-600 rounded-full text-white hover:bg-red-500",children:e.jsx(te,{size:24})}),e.jsx("button",{onClick:C,className:"p-4 bg-gray-700 rounded-full text-white hover:bg-gray-600",children:w.video?e.jsx(ue,{size:24}):e.jsx(ve,{size:24})})]})]}):e.jsxs("div",{className:"flex-1 flex  justify-center ",children:[e.jsx("video",{playsInline:!0,muted:!0,ref:d,autoPlay:!0,className:"w-[60vw]  object-cover"}),e.jsx("div",{className:"p-4 bg-gray-100",children:!y&&!N?e.jsxs("button",{onClick:()=>A(),className:"bg-green-500 text-white p-2 rounded w-full flex items-center justify-center",children:[e.jsx(se,{className:"mr-2"}),"Call"]}):e.jsxs("div",{className:"mt-4",children:[e.jsx("h1",{children:" is calling:"}),e.jsx("button",{onClick:D,className:"bg-blue-500 text-white p-2 rounded w-full mt-2",children:"Answer"})]})})]})})},we=()=>{var B,q;const{socket:c}=ae(),x=re(),u=ce(),i=M(a=>a.presisted.message),l=M(a=>a.presisted.user),I=M(a=>a.presisted.chat),_=M(a=>a.presisted.notification),[y,N]=o.useState(""),[p,v]=o.useState(null),[T,b]=o.useState(!1),[S,w]=o.useState(!1),[O,d]=o.useState(!1),[f,A]=o.useState(!1),[D,E]=o.useState(""),[C,V]=o.useState(null),[s,r]=o.useState(0),[h,U]=o.useState(!1),$=o.useRef(),m=o.useRef(null),{uploadFile:z}=xe(),H=(B=x==null?void 0:x.state)==null?void 0:B.id,R=(q=x==null?void 0:x.state)==null?void 0:q.userData;o.useEffect(()=>{$.current=new fe({path:"/peerjs",host:"localhost",port:5e3}),console.log($.current),c.on("typing",n=>{var g;console.log(n,i,"adsfasdfas"),n==((g=i==null?void 0:i.chat)==null?void 0:g._id)?w(!0):U(!0)}),c.on("stopTyping",n=>{var g;n==((g=i==null?void 0:i.chat)==null?void 0:g._id)?w(!1):U(!1)});const a=n=>{A(!0),E(n),d(!0)};c.on("connectUser",a);const t=async n=>{!m.current||m.current.uid!=n.response.sender?_.includes(n)||u(ie(n)):u(F(n)),u(G(n.response))};return c.on("message recieved",t),(async()=>{let n=await k.get(`/chat/getChat/${l.uid}`);u(le(n.data))})(),H?L(H):R&&a(R.peerId),()=>{m.current=null,u(ne())}},[]);const K=()=>{d(!0)},Q=async a=>{var t;if(!(!c||!p))try{const j=await z(p,p.type.split("/")[0],r),n=await k.post("/chat/file",{caption:a,user:l.uid,chat:(t=i==null?void 0:i.chat)==null?void 0:t._id,uid:m.current.uid,url:j[p.type.split("/")[0]],contentType:p.type.split("/")[0]});c.emit("new chat",n.data),u(F(n.data)),v(null)}catch(j){console.error(j)}},W=async()=>{var a;if(!(!c||!C))try{const t=`a_${Date.now()}.webm`,j=new File([C],t,{type:"audio/webm"}),n=await z(j,"audio",r),g=await k.post("/chat/file",{user:l.uid,uid:m.current.uid,contentType:"audio",url:n.audio,caption:"",chat:(a=i.chat)==null?void 0:a._id});c.emit("new chat",g.data),u(F(g.data))}catch(t){P(t.response.data.message?t.response.data.message:t.message)}},X=async()=>{var a;if(!(!c||!y.trim()))try{const t=await k.post("/chat/message",{content:y,user:l.uid,chat:(a=i.chat)==null?void 0:a._id,uid:m.current.uid});c.emit("new chat",t.data),u(F(t.data)),u(G(t.data.response)),N("")}catch(t){P(t.response.data.message?t.response.data.message:t.message)}},L=async a=>{try{m.current=a;const t=await k.get(`/chat/takeChat/${l.uid}/${a.uid}`);console.log("response",t),await u(await oe(t==null?void 0:t.data)),c.emit("join chat",t.data.chat._id)}catch(t){P(t.response.data.message?t.response.data.message:t.message)}},Y=a=>{N(a.target.value),T||(b(!0),console.log(i.chat),c.emit("typing",i.chat._id));let t=new Date().getTime();var j=3e3;setTimeout(()=>{var n=new Date().getTime(),g=n-t;g>=j&&T&&(c.emit("stopTyping",i.chat._id),b(!1))},j)},Z=a=>{const t=a.target.files[0];t&&v(t)},ee=()=>{};return e.jsxs("div",{className:"flex h-[90vh] bg-white",children:[e.jsx(he,{chats:I,user:l.uid,takeChat:L,isNotpresentInChat:h,which:"Message"}),O?e.jsx("div",{className:"w-2/3",children:e.jsx(be,{socket:c,receiver:m.current,setMe:d,chat:i,user:l,peer:$.current,caller:D,receivingCall:f})}):e.jsx(e.Fragment,{children:m.current&&e.jsxs("div",{className:"flex-1 flex flex-col",children:[e.jsx(me,{receiver:m.current,call:K,serachInMessage:ee}),p?e.jsx(pe,{fileContent:p,closeFileContainer:()=>v(null),sendFile:Q,perSec:s}):e.jsx(ge,{user:l.uid,chat:i.messages,isTyping:S,content:y,handleTyping:Y,sendMessage:X,audioBlob:C,setAudioBlob:V,handleFileClick:Z,sendAudio:W,receiver:m.current})]})})]})},ze=()=>e.jsxs("div",{className:"flex-row",children:[e.jsx(je,{}),e.jsx("div",{className:"flex-grow",children:e.jsx(we,{})})]});export{ze as default};
